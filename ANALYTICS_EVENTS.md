# Аналитические События

Этот документ описывает события, которые бот логирует в базу данных ClickHouse для последующего анализа в Yandex DataLens.

Все события записываются в таблицу `bot_events` и имеют общую структуру:
- `event_timestamp`: Время события
- `user_id`: ID пользователя в Telegram
- `event_type`: Тип события (описаны ниже)
- `event_data`: JSON-объект с дополнительными данными о событии

---

### 1. `new_user`

*   **Когда происходит:** Пользователь впервые запускает бота командой `/start`.
*   **Описание:** Регистрирует появление нового уникального пользователя. Также фиксирует, если пользователь пришел по реферальной ссылке.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "username": "some_username",
      "referrer_id": 123456789
    }
    ```
    *   `username`: Имя пользователя в Telegram (если установлено).
    *   `referrer_id`: (Опционально) ID пользователя, который пригласил нового юзера. Присутствует, только если был использован реферальный код.
    *   `source`: (Опционально) название источника, из которого пришел пользователь.

---

### 2. `start_command`

*   **Когда происходит:** Каждый раз, когда пользователь отправляет команду `/start`.
*   **Описание:** Логирует каждый запуск или перезапуск бота пользователем. Помогает отслеживать активность и удержание пользователей.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "username": "some_username"
    }
    ```
    *   `username`: Имя пользователя в Telegram (если установлено).

---

### 3. `generation_queued`

*   **Когда происходит:** Пользователь подтверждает все настройки и задача ставится в очередь на генерацию.
*   **Описание:** Фиксирует момент постановки заказа в очередь. Является успешным завершением воронки конфигурации.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "url": "https://youtube.com/watch?v=...",
      "config": {
        "shorts_number": 3,
        "layout": "top_bottom",
        "bottom_video": "minecraft",
        "subtitles_type": "word-by-word",
        "subtitle_style": "yellow",
        "force_ai_transcription": false,
        "capitalize_sentences": false
      },
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `url`: Ссылка на исходное YouTube видео.
    *   `config`: JSON-объект со всеми настройками, которые выбрал пользователь.
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 4. `generation_start`

*   **Когда происходит:** Воркер забирает задачу из очереди и начинает ее обработку.
*   **Описание:** Фиксирует фактическое начало выполнения заказа на генерацию.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 5. `generation_success`

*   **Когда происходит:** Процесс обработки видео успешно завершен, и было создано хотя бы одно короткое видео.
*   **Описание:** Фиксирует успешное выполнение заказа.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "url": "https://youtube.com/watch?v=...",
      "config": { ... },
      "generated_count": 3,
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `url`, `config`: Аналогично событию `generation_start`.
    *   `generated_count`: Количество фактически созданных шортсов.
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 6. `generation_error`

*   **Когда происходит:** Процесс обработки видео завершился с ошибкой на любом этапе, или не было создано ни одного видео.
*   **Описание:** Фиксирует неудачную попытку генерации.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "url": "https://youtube.com/watch?v=...",
      "config": { ... },
      "error": "Текст ошибки",
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `url`, `config`: Аналогично событию `generation_start`.
    *   `error`: Текстовое описание ошибки (например, "No shorts generated" или текст системного исключения).
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 7. `send_video_error`

*   **Когда происходит:** Ошибка при отправке видео пользователю.
*   **Описание:** Фиксирует неудачную попытку отправки видео пользователю.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "file_path": "/path/to/video.mp4",
      "error": "Текст ошибки"
    }
    ```
    *   `file_path`: Путь к файлу видео.
    *   `error`: Текстовое описание ошибки (например, "No shorts generated" или текст системного исключения).

---

### 8. `payment_success`

*   **Когда происходит:** Пользователь успешно пополняет свой баланс.
*   **Описание:** Фиксирует успешное пополнение.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "provider": "telegram_stars" или "cryptobot",
      "shorts_amount": 10,
      "total_amount": 100,
      "currency": "XTR" или "USDT"
    }
    ```
    *   `provider`: Способ оплаты (`telegram_stars` или `cryptobot`).
    *   `shorts_amount`: Количество купленных "шортсов".
    *   `total_amount`: Сумма платежа в указанной валюте.
    *   `currency`: Валюта платежа (`XTR` для Stars, `USDT` для CryptoBot).

---

### 9. `rating`

*   **Когда происходит:** Пользователь нажимает на кнопку оценки (1-5) после завершения генерации.
*   **Описание:** Записывает оценку удовлетворенности пользователя результатом. Каждой оценке присваивается уникальный `rating_id` для связи с возможным последующим текстовым отзывом.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "rating_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
      "rating": "5",
      "generation_id": "f0e9d8c7-b6a5-4321-fedc-ba9876543210"
    }
    ```
    *   `rating_id`: Уникальный идентификатор сессии оценки.
    *   `rating`: Оценка от 1 до 5, которую поставил пользователь.
    *   `generation_id`: Идентификатор сессии генерации, к которой относится оценка.

---

### 10. `feedback`

*   **Когда происходит:** Пользователь отправляет текстовый отзыв после того, как поставил оценку.
*   **Описание:** Событие, указывающее, что пользователь оставил текстовый отзыв. Само тело отзыва не логируется в целях конфиденциальности и экономии места, но его наличие связывается с ранее поставленной оценкой через `rating_id`.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "rating_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `rating_id`: Уникальный идентификатор сессии оценки, к которой относится этот отзыв.

---

### 11. `video_availability_error`

*   **Когда происходит:** Пользователь отправляет ссылку на YouTube видео, которое недоступно для скачивания (приватное, удалено, ограничения по стране).
*   **Описание:** Фиксирует ошибку доступности видео на самом первом этапе, до начала основной обработки.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "url": "https://youtube.com/watch?v=...",
      "error": "Текст ошибки, который был показан пользователю"
    }
    ```
    *   `url`: Ссылка на недоступное видео.
    *   `error`: Текст ошибки, который был показан пользователю.

---

## События Воронки Конфигурации

Эти события предназначены для отслеживания пути пользователя в процессе настройки параметров генерации видео. Каждая сессия конфигурации имеет уникальный `generation_id`, который связывает все шаги воедино.

### 12. `config_video_url_provided`

*   **Когда происходит:** Пользователь отправляет ссылку на YouTube видео, начиная процесс конфигурации.
*   **Описание:** Первый шаг воронки. Фиксирует начало сессии конфигурации и ей присваивается `generation_id`.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "url": "https://youtube.com/watch?v=...",
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `url`: Ссылка на видео.
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 13. `config_step_shorts_number_selected`

*   **Когда происходит:** Пользователь выбирает количество шортсов (числом или "Авто").
*   **Описание:** Второй шаг воронки.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "choice": "auto" или 5,
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `choice`: Выбор пользователя ('auto' или число).
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 14. `config_step_layout_selected`

*   **Когда происходит:** Пользователь выбирает сетку видео.
*   **Описание:** Третий шаг воронки.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "choice": "square_center",
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `choice`: Выбранная сетка (например, `square_center`, `full_top_brainrot_bottom`).
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 15. `config_step_bottom_video_selected`

*   **Когда происходит:** Пользователь выбирает фоновое "brainrot" видео.
*   **Описание:** Шаг воронки, который происходит только если выбрана сетка с фоном.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "choice": "minecraft" или null,
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `choice`: Выбранное видео (`gta`, `minecraft`) или `null`.
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 16. `config_step_subtitles_type_selected`

*   **Когда происходит:** Пользователь выбирает тип отображения субтитров.
*   **Описание:** Шаг воронки по настройке субтитров.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "choice": "word-by-word",
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `choice`: Выбранный тип (`word-by-word`, `phrases`, `no_subtitles`).
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 17. `config_step_subtitle_style_selected`

*   **Когда происходит:** Пользователь выбирает цвет субтитров.
*   **Описание:** Финальный шаг настройки перед подтверждением.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "choice": "yellow",
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `choice`: Выбранный цвет (`yellow`, `white`, и т.д.).
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 18. `config_step_face_tracking_selected`

*   **Когда происходит:** Пользователь выбирает, нужно ли использовать трекинг лиц.
*   **Описание:** Шаг воронки по настройке трекинга лиц.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "choice": true,
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `choice`: Выбор пользователя (`true` или `false`).
    *   `generation_id`: Уникальный идентификатор сессии генерации.

---

### 19. `config_cancelled`

*   **Когда происходит:** Пользователь нажимает "Отклонить" на экране подтверждения настроек.
*   **Описание:** Фиксирует отказ от генерации на последнем шаге. Помогает понять, почему пользователи не доходят до постановки в очередь.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `generation_id`: Уникальный идентификатор сессии генерации, которая была отменена.

---

### 20. `demo_started`

*   **Когда происходит:** Новый пользователь нажимает кнопку "Попробовать на демо-видео".
*   **Описание:** Фиксирует начало демо-воронки для нового пользователя.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `generation_id`: Уникальный идентификатор сессии демонстрации.

---

### 21. `demo_confirmed`

*   **Когда происходит:** Пользователь подтверждает конфигурацию в демо-режиме.
*   **Описание:** Фиксирует успешный старт имитации генерации в демо-режиме.
*   **Полезная нагрузка (`event_data`):**
    ```json
    {
      "generation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
    *   `generation_id`: Уникальный идентификатор сессии демонстрации.